<div class="polls-container">
  <h2>My Polls</h2>
 <app-export-csv [data]="pollsCsvData" filename="poll-results.csv"></app-export-csv>


  <div class="add-btn-container">
    <button class="add-btn" (click)="showCreateForm()">+ Create Poll</button>
  </div>


  <div class="search-container">
    <input
      type="text"
      placeholder="Search polls..."
      [(ngModel)]="searchTerm"
      (input)="applyFilters()"
    />
  </div>


  <table class="polls-table">
    <thead>
      <tr>
        <th (click)="sort('question')">Question
           <span *ngIf="sortColumn === 'question'">
    <span *ngIf="sortDirection === 'asc'">&#9650;</span>
    <span *ngIf="sortDirection === 'desc'">&#9660;</span>
  </span>
        </th>
        <th (click)="sort('createdAt')">Created <span *ngIf="sortColumn === 'createdAt'">
    <span *ngIf="sortDirection === 'asc'">&#9650;</span>
    <span *ngIf="sortDirection === 'desc'">&#9660;</span>
  </span></th>
        <th (click)="sort('expiresAt')">Expires
           <span *ngIf="sortColumn === 'expiresAt'">
    <span *ngIf="sortDirection === 'asc'">&#9650;</span>
    <span *ngIf="sortDirection === 'desc'">&#9660;</span>
  </span>
        </th>
        <th (click)="sort('status')">
  Status
  <span *ngIf="sortColumn === 'status'">
    <span *ngIf="sortDirection === 'asc'">&#9650;</span>
    <span *ngIf="sortDirection === 'desc'">&#9660;</span>
  </span>
</th>

        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let poll of filteredPolls">
        <td>{{ poll.question }}</td>
        <td>{{ poll.createdAt | date : 'short' }}</td>
        <td>{{ poll.expiresAt | date : 'short' }}</td>
        <td [class.active]="isActive(poll)" [class.expired]="!isActive(poll)">
          {{ isActive(poll) ? 'Active' : 'Expired' }}
        </td>
        <td>
         <button class="vote-btn" (click)="vote(poll)">
    View Poll
  </button>
  <button
    class="edit-btn"
    (click)="showEditForm(poll)"
    *ngIf="isActive(poll)">
    Edit
  </button>

  <button
    class="delete-btn"
    (click)="deletePoll(poll.id)"
    *ngIf="isActive(poll)">
    Delete
  </button>
        </td>
      </tr>
    </tbody>
  </table>

  <div class="pagination">
    <button (click)="goToPage(currentPage - 1)" [disabled]="currentPage === 1">Prev</button>
    <button
      *ngFor="let page of [].constructor(totalPages); let i = index"
      (click)="goToPage(i + 1)"
      [class.active]="currentPage === i + 1"
    >
      {{ i + 1 }}
    </button>
    <button (click)="goToPage(currentPage + 1)" [disabled]="currentPage === totalPages">
      Next
    </button>
  </div>

  <div class="modal" *ngIf="showForm">
    <div class="modal-content card">
      <span class="close" (click)="closeForm()">&times;</span>
      <h3>{{ formTitle }}</h3>

      <form (ngSubmit)="savePoll()" class="poll-form">

        <div class="form-group">
          <label for="question">Poll Question</label>
          <input
            id="question"
            type="text"
            [(ngModel)]="question"
            name="question"
            required
            placeholder="Enter your question"
          />
        </div>


        <div class="form-group">
          <label>Options</label>
          <div
            *ngFor="let option of options; let i = index; trackBy: trackByIndex"
            class="option-item"
          >
            <input
              type="text"
              [(ngModel)]="options[i]"
              [name]="'option'+i"
              required
              placeholder="Option {{i+1}}"
            />
            <button
              type="button"
              class="remove-btn"
              (click)="removeOption(i)"
              *ngIf="options.length > 2"
            >
              ‚ùå
            </button>
          </div>
          <button type="button" class="add-btn" (click)="addOption()">+ Add Option</button>
        </div>


        <div class="form-group">
          <label for="expiresAt">Expiry Date</label>
          <input
            id="expiresAt"
            type="date"
            [(ngModel)]="expiresAt"
            name="expiresAt"

          />
        </div>


        <div class="form-actions">
          <button type="submit" class="submit-btn" [disabled]="!isPollValid">
            Save Poll
          </button>
          <button type="button" class="cancel-btn" (click)="closeForm()">Cancel</button>
        </div>
      </form>
    </div>
  </div>


  <div class="modal" *ngIf="showVoteForm && activePoll">
    <div class="modal-content card">
      <span class="close" (click)="closeVoteForm()">&times;</span>
      <h3>{{ activePoll.question }}</h3>


      <div *ngIf="!showResultsMap[activePoll.id]" class="vote-form">
        <label *ngFor="let option of activePoll.options; let i = index" class="vote-label">
          <input
            type="checkbox"
            [(ngModel)]="selectedOptionIndex"
            [value]="i"
            name="voteOption"
          />
          {{ option.text }}
        </label>
        <button
          class="submit-btn"
          (click)="submitVote()"
          [disabled]="isSubmittingVote || selectedOptionIndex === null"
        >
          {{ isSubmittingVote ? 'Submitting...' : 'Submit Vote' }}
        </button>
      </div>


      <div *ngIf="showResultsMap[activePoll.id]" class="results">
        <div *ngFor="let option of activePoll.options; let i = index" class="result-item">
          <div class="result-text">
            {{ option.text }} - {{ option.voteCount }} votes ({{ getVotePercentage(i) }}%)
          </div>
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="getVotePercentage(i)"></div>
          </div>
        </div>
        <button class="submit-btn" (click)="closeVoteForm()">Close</button>
      </div>
    </div>
  </div>
</div>
